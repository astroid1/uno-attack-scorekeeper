<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>UNO Attack Scorekeeper</title>
<!--  (CSS unchanged — clipped for brevity; keep the same <style> block you already have) -->
</head>
<body>
<div id="app">                 <!--  ... HTML up to board stays the same ... --> </div>

<script>
const $ = s => document.querySelector(s);

/* ─── card values & helpers ─── */
const CARD_VALUES={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,
  Reverse:20,Skip:20,"Hit 2":20,"Discard All":30,"Trade Hands":30,
  Wild:50,"Wild All Hit":50,"Wild Hit Fire":50,"Wild Attack-Attack":50};
const CARD_NAMES=Object.keys(CARD_VALUES);

const makeSelect = (selected='0') =>{
  const s=document.createElement('select');s.className='card';
  CARD_NAMES.forEach(c=>s.add(new Option(c,c,0,c===selected)));
  return s;
};
const sumHand   = sel => [...sel].reduce((t,s)=>t+CARD_VALUES[s.value],0);
const grabHandValues = sel => [...sel].map(s=>s.value);
const renderHand = (container,values=[])=>{
  container.innerHTML='';
  values.forEach(v=>container.append(makeSelect(v)));
  const add=document.createElement('button');
  add.textContent='+';add.type='button';add.className='add';
  add.onclick=()=>container.insertBefore(makeSelect(),add);
  container.append(add);
};

/* ─── game state ─── */
let players=0, rounds=0, round=1;
let names=[], totals=[], roundScores=[], roundHands=[];

/* STEP-1 → STEP-2 … (same) */

/* STEP-2 → BOARD … (same, but reset arrays) */
function startGame(){
  round=1;
  totals=Array(players).fill(0);
  roundScores=[];       // clear past
  roundHands =[];       // ← new: store card selections per round
  $('#winner').hidden=true; $('#history').hidden=true; $('#back').hidden=true;
  buildBoard(); buildHistHeader();
}

/* buildBoard(): replace addHandUI call with renderHand */
function buildBoard(){
  const tbody=$('#table tbody'); tbody.innerHTML='';
  for(let i=0;i<players;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${names[i]}</td>
      <td class="hand"><div class="hand-inner"></div></td>
      <td class="round">0</td>
      <td class="total">${totals[i]}</td>`;
    tbody.append(tr);
    renderHand(tr.querySelector('.hand-inner'));  // ←
  }
  $('#roundNow').textContent=round; $('#roundMax').textContent=rounds;
}

/* SAVE Round (auto-advance) */
$('#save').onclick=()=>{
  const thisScores=[], thisHands=[];

  [...$('#table tbody').rows].forEach((tr,i)=>{
    const selects=tr.querySelectorAll('select.card');
    const handValues=grabHandValues(selects);     // ← values for player i
    const score=sumHand(selects);

    thisScores.push(score);
    thisHands.push(handValues);

    totals[i]+=score;
    tr.querySelector('.round').textContent=score;
    tr.querySelector('.total').textContent=totals[i];
  });

  roundScores.push(thisScores);
  roundHands .push(thisHands);                    // ← store hand arrays
  addHistRow(round,thisScores);
  $('#history').hidden=false; $('#back').hidden=false;

  if(round>=rounds){
    declareWinner(); $('#save').hidden=true;
  }else{
    round++; $('#roundNow').textContent=round;
    resetForNextRound();                          // new helper (see below)
  }
};

/* helper to prep next-round inputs w/ blanks */
function resetForNextRound(){
  [...$('#table tbody').rows].forEach(tr=>{
    tr.querySelector('.round').textContent='0';
    renderHand(tr.querySelector('.hand-inner'));  // blank selects
  });
}

/* BACK a round — keep & restore selections */
$('#back').onclick=()=>{
  if(!roundScores.length)return;

  const lastScores = roundScores.pop();
  const lastHands  = roundHands .pop();           // ← selections to restore
  totals=totals.map((t,i)=>t-lastScores[i]);
  round--;

  // remove history row
  $('#histTable tbody').lastElementChild.remove();
  $('#history').hidden=!roundScores.length;
  $('#winner').hidden=true; $('#save').hidden=false;
  if(round===1&&!roundScores.length) $('#back').hidden=true;

  // rebuild per-player rows with saved hand values
  [...$('#table tbody').rows].forEach((tr,i)=>{
    tr.querySelector('.round').textContent='0';
    tr.querySelector('.total').textContent=totals[i];
    renderHand(tr.querySelector('.hand-inner'), lastHands[i]);  // ← restore
  });
  $('#roundNow').textContent=round;
};

/* rest of JS (declareWinner, addHistRow, reset, etc.) stays unchanged */
</script>
</body>
</html>
